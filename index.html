<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Penjadwalan Regu Jaga Modern</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* -- Fondasi & Tipografi -- */
    :root {
      --brand-color: #2563eb; /* blue-600 */
      --brand-color-hover: #1d4ed8; /* blue-700 */
      --gray-soft-bg: #f8fafc; /* slate-50 */
      --gray-border: #e2e8f0; /* slate-200 */
      --text-main: #1e293b; /* slate-800 */
      --text-muted: #64748b; /* slate-500 */
    }
    body {
      background-color: var(--gray-soft-bg);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Menggunakan variabel untuk konsistensi */
    th, td { font-size: 14px !important; padding: 0.75rem 1rem !important; letter-spacing: 0.01em;}
    table { border-collapse: separate; border-spacing: 0; }

    /* -- Header Utama -- */
    .main-header {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-bottom: 1px solid var(--gray-border);
    }

    /* -- Panel Konfigurasi -- */
    #configForm {
        border: 1px solid var(--gray-border);
        background: white;
        border-radius: 0.75rem; /* rounded-xl */
        padding: 1.5rem; /* p-6 */
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
    }
    #configForm label {
        color: var(--text-main);
        font-weight: 500; /* font-medium */
    }
    #configForm input[type="date"],
    #configForm textarea {
        border-radius: 0.375rem; /* rounded-md */
        border: 1px solid #cbd5e1; /* slate-300 */
        padding: 0.5rem 0.75rem; /* p-2 px-3 */
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    #configForm input[type="date"]:focus,
    #configForm textarea:focus {
        outline: none;
        border-color: var(--brand-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    /* -- Tombol Aksi -- */
    .btn {
        @apply px-4 py-2 rounded-md font-semibold text-sm transition-all duration-150;
    }
    .btn-primary {
        background: var(--brand-color);
        color: white;
        box-shadow: 0 1px 2px #0002;
    }
    .btn-primary:hover {
        background: var(--brand-color-hover);
        box-shadow: 0 2px 4px #0003;
        transform: translateY(-1px);
    }
    .btn-secondary {
        background: #e2e8f0; /* slate-200 */
        color: #334155; /* slate-700 */
    }
    .btn-secondary:hover {
        background: #cbd5e1; /* slate-300 */
    }
    
    /* -- View Toggle -- */
    .view-toggle-wrapper {
        background: #eef2f9; /* slate-100 */
        border-radius: 0.5rem; /* rounded-lg */
        padding: 0.25rem; /* p-1 */
        border: 1px solid var(--gray-border);
        box-shadow: inset 0 1px 2px #0001;
    }
    .btn-toggle {
        @apply px-4 py-1.5 rounded-md font-medium text-sm transition-colors duration-200;
        color: var(--text-muted);
        border: 1px solid transparent;
    }
    .btn-toggle.active, .btn-toggle:focus-visible {
        background: white !important;
        color: var(--brand-color) !important;
        box-shadow: 0 1px 3px #0000001a;
        outline: none;
    }
    .btn-toggle:hover:not(.active) {
        color: var(--text-main);
    }
    #viewToggleContainer { margin-bottom: 1.5rem; }

    /* -- Filter Bar -- */
    .filter-bar { 
        gap: 1rem; 
        margin-bottom: 1.5rem;
    }
    .filter-bar select, .filter-bar label { font-size: 13px; color: var(--text-muted); }
    .filter-bar select { 
        border: 1px solid #cbd5e1; /* slate-300 */
        border-radius: 0.375rem; /* rounded-md */
        padding: 0.25rem 0.5rem;
    }
    .filter-bar input[type="checkbox"] { 
        width: 14px; height: 14px;
        border-radius: 4px;
        border-color: #cbd5e1;
    }

    /* -- Notifikasi Toast -- */
    #notifToast {
      transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      border-radius: 0.5rem;
      font-weight: 500;
    }

    /* ==== TAMPILAN TABEL ==== */
    .panel-month { 
      min-width:380px; 
      background:white; 
      border-radius:0.75rem; /* rounded-xl */
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      padding: 0;
      margin-bottom:2rem;
      border: 1px solid var(--gray-border);
      overflow: hidden;
    }
    .sticky-month {
      position: sticky;
      /* Top value should be slightly more than the main header's height */
      top: 69px; 
      z-index: 3;
      background: rgba(248, 250, 252, 0.85); /* slate-50 dengan transparansi */
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      font-size: 1.125rem; /* text-lg */
      font-weight: 600; /* font-semibold */
      padding: 1rem 1.5rem;
      color: var(--text-main);
      border-bottom: 1px solid var(--gray-border);
    }
    /* Modernisasi Tabel */
    .panel-month table { border-collapse: collapse; width: 100%; }
    .panel-month thead th {
        background: #f8fafc; /* slate-50 */
        position: sticky;
        /* Top value = .sticky-month's top + its height */
        top: 130px; 
        z-index: 2;
        text-align: left;
        font-size: 12px !important;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
        border: none;
        border-bottom: 1px solid var(--gray-border);
    }
    .panel-month td, .panel-month th {
        border: none;
        border-bottom: 1px solid var(--gray-border);
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
    .panel-month tbody tr:last-child td { border-bottom: none; }
    .panel-month .holiday-row { background: #fff1f2 !important; color: #be123c !important; font-weight: 500;}
    .panel-month .row-alt { background: #fcfcfd !important; }
    .empty-cell { background: #fff; border: none;}
    .panel-month .overflow-x-auto { padding-bottom: 1rem; }


    /* ==== TAMPILAN KALENDER ==== */
    .calendar-container { 
      background: white;
      border-radius: 0.75rem; /* rounded-xl */
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      margin-bottom: 2rem; 
      overflow: hidden; 
      border: 1px solid var(--gray-border);
    }
    .calendar-header { 
      background: var(--gray-soft-bg);
      padding: 1rem; 
      text-align: center; 
      font-weight: 600; 
      font-size: 1.125rem; /* text-lg */
      color: var(--text-main);
      border-bottom: 1px solid var(--gray-border);
    }
    .calendar-grid { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr);
      /* Menghilangkan border antar cell, diganti gap */
      gap: 1px;
      background-color: var(--gray-border);
    }
    .calendar-day-header { 
      background: var(--gray-soft-bg);
      padding: 0.75rem 0.25rem; 
      text-align: center; 
      font-weight: 600; 
      font-size: 0.75rem; /* text-xs */
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .calendar-day { 
      min-height: 110px; 
      padding: 0.5rem; 
      position: relative; 
      background: white;
      transition: background-color 0.2s;
    }
    .calendar-day.other-month { background: var(--gray-soft-bg); }
    .calendar-day.other-month .calendar-date { color: #94a3b8; /* slate-400 */ }
    .calendar-day.holiday { background: #fee2e2; }
    .calendar-day.today { background: #e0f2fe; /* sky-100 */ }
    .calendar-date { 
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        transition: all 0.2s;
    }
    .today .calendar-date {
        background-color: var(--brand-color);
        color: white;
    }
    .calendar-guards { font-size: 0.75rem; line-height: 1.4; }
    .guard-item { 
      background: #e0e7ff; /* indigo-100 */
      color: #3730a3; /* indigo-800 */
      padding: 0.2rem 0.4rem; 
      margin: 0.25rem 0; 
      border-radius: 0.25rem;
      font-weight: 500;
      display: block;
    }
    .guard-item.holiday { 
        background: #fecaca; /* red-200 */
        color: #991b1b; /* red-800 */
    }
    @media (max-width:900px) {
      .panel-month { min-width: 0;}
      .calendar-day { min-height: 90px; padding: 0.35rem; }
      .calendar-guards { font-size: 0.6875rem; }
      .guard-item { padding: 0.1rem 0.25rem; }
      .sticky-month { top: 65px; }
      .panel-month thead th { top: 125px; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-700">

  <div class="main-header w-full p-4 mb-6 sticky top-0 z-20">
    <h1 class="text-xl font-semibold text-center text-slate-800">Penjadwalan Regu Jaga</h1>
  </div>

  <div id="main-content" class="max-w-6xl mx-auto px-4">
    <form id="configForm" class="bg-white rounded-md shadow p-4 mb-6">
      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <label class="block text-sm mb-2 font-medium">Tanggal Mulai</label>
          <input type="date" id="startDate" required class="border rounded w-full p-1 text-sm"/>
          <label class="block mt-4 text-sm mb-2 font-medium">Tanggal Selesai</label>
          <input type="date" id="endDate" required class="border rounded w-full p-1 text-sm"/>
        </div>
        <div>
          <label class="block text-sm mb-2 font-medium">Daftar Regu (satu per baris)</label>
          <textarea id="groupList" rows="7" required class="border rounded w-full p-1 text-sm resize-none"></textarea>
          <div class="flex items-center gap-2 mt-2">
            <input type="file" id="importTxt" accept=".txt" class="hidden"/>
            <button type="button" id="importBtn" class="px-2 py-1 text-xs bg-slate-200 rounded hover:bg-slate-300">Import TXT</button>
            <span id="importStat" class="text-xs text-green-600"></span>
          </div>
        </div>
        <div>
          <label class="block text-sm mb-2 font-medium">Hari Libur (pilih tanggal)</label>
          <div id="holidayPicker" class="flex flex-wrap gap-1 mb-2"></div>
          <input type="date" id="holidayInput" class="border rounded p-1 text-sm"/>
          <button type="button" id="addHolidayBtn" class="ml-1 px-2 py-1 text-xs bg-slate-200 rounded hover:bg-slate-300">Tambah</button>
          <div class="mt-4">
            <label class="block text-sm mb-2 font-medium">Opsi Urutan Regu</label>
            <div class="flex gap-4 mt-1">
              <label class="flex items-center gap-1.5 text-sm"><input type="radio" name="orderType" value="shuffle" checked class="h-4 w-4"/> Acak per siklus</label>
              <label class="flex items-center gap-1.5 text-sm"><input type="radio" name="orderType" value="manual" class="h-4 w-4"/> Manual (urutan tetap)</label>
            </div>
          </div>
        </div>
      </div>
      <div class="flex gap-3 mt-6 justify-end">
        <button type="button" id="resetBtn" class="btn btn-secondary">Reset</button>
        <button type="submit" class="btn btn-primary">Generate Jadwal</button>
      </div>
    </form>

    <div id="viewToggleContainer" class="mb-4 flex justify-center" style="display: none;">
      <div class="view-toggle-wrapper flex">
        <button id="tableViewBtn" type="button" class="btn-toggle active">Tampilan Tabel</button>
        <button id="calendarViewBtn" type="button" class="btn-toggle">Tampilan Kalender</button>
      </div>
    </div>

    <div id="filterBar" class="filter-bar mb-3 flex-wrap items-center no-print" style="display:none;">
      <label>Bulan:
        <select id="filterBulan" class="border px-1 rounded"></select>
      </label>
      <label>Grup:
        <select id="filterGrup" class="border px-1 rounded"></select>
      </label>
      <label class="flex gap-1 items-center"><input type="checkbox" id="filterLibur"/> Hari Libur Saja</label>
      <button id="downloadXLSX" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded-md hover:bg-green-700 ml-auto font-semibold">Download Excel</button>
      <button id="downloadCSV" class="px-3 py-1.5 text-xs bg-sky-600 text-white rounded-md hover:bg-sky-700 font-semibold">Download CSV</button>
      <button id="exportGenerator" class="px-3 py-1.5 text-xs bg-yellow-500 text-white rounded-md hover:bg-yellow-600 font-semibold">Export Generator</button>
      <input type="file" id="importGenerator" accept=".json" class="ml-2 hidden"/>
      <button type="button" id="importGenBtn" class="px-3 py-1.5 text-xs bg-yellow-100 text-yellow-900 rounded-md hover:bg-yellow-200 border border-yellow-400 ml-1 font-semibold">Import Generator</button>
    </div>

    <div id="scheduleOut" class="overflow-x-auto"></div>
    <div id="notifToast" class="fixed left-1/2 bottom-7 z-50 px-4 py-2 rounded shadow-md border transition-all bg-white text-slate-700 text-sm"
      style="display:none;transform:translateX(-50%);min-width:180px;">
      <span id="notifToastMsg"></span>
    </div>
  </div>

<script>
let holidays = [];
let lastJadwal = [];
let lastGroups = [];
let lastMonths = [];
let lastConfig = {};
let currentView = 'table';

// Notifikasi minimalis
function showNotif(msg, variant = "success") {
  const toast = document.getElementById('notifToast');
  const msgSpan = document.getElementById('notifToastMsg');
  msgSpan.textContent = msg;
  toast.style.display = '';
  toast.classList.remove("border-green-600","border-red-600","bg-green-50","bg-red-50","text-green-900","text-red-900");
  if (variant === "success") {
    toast.classList.add("border-green-600","bg-green-50", "text-green-900");
  } else if (variant === "error") {
    toast.classList.add("border-red-600","bg-red-50", "text-red-900");
  }
  setTimeout(() => {
    toast.style.opacity = "1";
    toast.style.pointerEvents = "auto";
    toast.style.bottom = "2.5rem";
  }, 10);
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.pointerEvents = "none";
    toast.style.bottom = "1.75rem";
    setTimeout(()=>{toast.style.display = 'none';}, 400);
  }, 2200);
}

// Set tanggal selesai default 1 bulan dari tanggal mulai
document.getElementById('startDate').addEventListener('change', function() {
  const start = this.value;
  if (!start) return;
  const startDate = new Date(start);
  const endDate = new Date(startDate);
  endDate.setMonth(startDate.getMonth() + 1);
  endDate.setDate(endDate.getDate() -1); // End on the day before the next month
  document.getElementById('endDate').value = endDate.toISOString().slice(0,10);
});

function formatTanggal(iso) {
  const hari = ['Min','Sen','Sel','Rab','Kam','Jum','Sab'];
  const bulan = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
  let d = new Date(iso + "T00:00:00"); // Avoid timezone issues
  return `${hari[d.getDay()]}, ${d.getDate()} ${bulan[d.getMonth()]}`;
}
function formatBulanTahun(iso) {
  const bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  let d = new Date(iso + "T00:00:00"); // Avoid timezone issues
  return `${bulan[d.getMonth()]} ${d.getFullYear()}`;
}
function groupByMonth(jadwal) {
  let map = {};
  jadwal.forEach(row => {
    let ym = row.date.slice(0,7);
    if (!map[ym]) map[ym]=[];
    map[ym].push(row);
  });
  return map;
}
function padRows(arr, n) {
  let mod = arr.length % n;
  if (mod === 0) return arr.slice();
  let padded = arr.slice();
  for (let i=0; i < n-mod; i++) padded.push(null);
  return padded;
}

/* ==== View Toggle Functions ==== */
function initViewToggle() {
  const tableBtn = document.getElementById('tableViewBtn');
  const calendarBtn = document.getElementById('calendarViewBtn');
  const container = document.getElementById('viewToggleContainer');
  const filterBar = document.getElementById('filterBar');
  container.style.display = 'flex';
  filterBar.style.display = 'flex';
  tableBtn.onclick = () => switchView('table');
  calendarBtn.onclick = () => switchView('calendar');
}
function switchView(view) {
  currentView = view;
  const tableBtn = document.getElementById('tableViewBtn');
  const calendarBtn = document.getElementById('calendarViewBtn');
  if (view === 'table') {
    tableBtn.classList.add('active');
    calendarBtn.classList.remove('active');
  } else {
    calendarBtn.classList.add('active');
    tableBtn.classList.remove('active');
  }
  if (lastJadwal.length > 0) {
    renderScheduleOutput(lastJadwal, lastGroups);
  }
}

/* ==== Hari Libur Picker ==== */
function renderHolidayPicker() {
  const container = document.getElementById('holidayPicker');
  container.innerHTML = '';
  holidays.sort();
  holidays.forEach((d, idx) => {
    const badge = document.createElement('span');
    badge.className = 'bg-red-100 text-red-700 text-xs font-medium rounded px-2 py-1 cursor-pointer hover:bg-red-200';
    badge.innerText = formatTanggal(d);
    badge.title = 'Klik untuk hapus';
    badge.onclick = () => { holidays.splice(idx,1); renderHolidayPicker(); };
    container.appendChild(badge);
  });
}
document.getElementById('addHolidayBtn').onclick = function() {
  const val = document.getElementById('holidayInput').value;
  if (val && !holidays.includes(val)) {
    holidays.push(val);
    renderHolidayPicker();
    document.getElementById('holidayInput').value = '';
  }
};

/* ==== Import TXT ==== */
document.getElementById('importBtn').onclick = () => document.getElementById('importTxt').click();
document.getElementById('importTxt').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    const lines = ev.target.result.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    document.getElementById('groupList').value = lines.join('\n');
    document.getElementById('importStat').innerText = 'Berhasil diimport!';
    setTimeout(()=>{document.getElementById('importStat').innerText='';}, 2000);
  };
  reader.readAsText(file);
};

/* ==== Reset ==== */
document.getElementById('resetBtn').onclick = function() {
  document.getElementById('configForm').reset();
  document.getElementById('groupList').value = '';
  holidays = [];
  renderHolidayPicker();
  document.getElementById('scheduleOut').innerHTML = '';
  document.getElementById('viewToggleContainer').style.display = 'none';
  document.getElementById('filterBar').style.display = 'none';
  lastJadwal = [];
  lastGroups = [];
  lastMonths = [];
  lastConfig = {};
};

/* ==== Generate ==== */
document.getElementById('configForm').onsubmit = function(e) {
  e.preventDefault();

  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  let groups = document.getElementById('groupList').value.split('\n').map(g=>g.trim()).filter(Boolean);
  const orderType = document.querySelector('input[name="orderType"]:checked').value;
  
  if (groups.length < 2) {
    showNotif('Minimal 2 regu diperlukan!', 'error');
    return;
  }
  if (!startDate || !endDate || startDate > endDate) {
    showNotif('Tanggal mulai/selesai tidak valid!', 'error');
    return;
  }
  
  const jadwal = generateSchedule(startDate, endDate, holidays, groups, orderType);
  lastJadwal = jadwal;
  lastGroups = groups;
  lastMonths = Array.from(new Set(jadwal.map(j=>j.date.slice(0,7))));
  lastConfig = {
    startDate, endDate, holidays:[...holidays], groups:[...groups], orderType
  };
  
  initViewToggle();
  renderFilterBar(jadwal, groups);
  renderScheduleOutput(jadwal, groups);
  showNotif('Jadwal berhasil dibuat!');
};

/* ==== Jadwal Generator with Fair Shuffle ==== */
function shuffleArray(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function generateSchedule(start, end, holidaysList, groupList, orderType) {
  let days = [];
  let cur = new Date(start + "T00:00:00");
  const endDate = new Date(end + "T00:00:00");
  holidaysList = holidaysList.slice();
  
  while (cur <= endDate) {
    const iso = cur.toISOString().slice(0,10);
    days.push({date: iso, isHoliday: holidaysList.includes(iso)});
    cur.setDate(cur.getDate()+1);
  }
  
  let schedule = [];
  if (orderType === 'manual') {
    let pool = groupList.slice();
    let idx = 0;
    for (let d of days) {
      if (d.isHoliday) {
        schedule.push({date: d.date, group1: 'LIBUR', group2: '', isHoliday:true});
        continue;
      }
      let g1 = pool[idx % pool.length];
      let g2 = pool[(idx+1)%pool.length] || g1;
      idx++;
      schedule.push({date: d.date, group1: g1, group2: g2, isHoliday:false});
    }
  } else { // shuffle
    let pool = [];
    let cycle = 0;
    for (let d of days) {
        if (d.isHoliday) {
            schedule.push({ date: d.date, group1: 'LIBUR', group2: '', isHoliday: true });
            continue;
        }
        if (pool.length === 0) {
            pool = shuffleArray(groupList);
            // Optional: Prevent first element of new shuffle from being the same as the last element of the old one
            if (schedule.length > 0 && !schedule[schedule.length - 1].isHoliday) {
                const lastGroup = schedule[schedule.length - 1].group1;
                while (pool[0] === lastGroup) {
                    pool = shuffleArray(groupList);
                }
            }
        }
        const assignedGroup = pool.shift();
        schedule.push({ date: d.date, group1: assignedGroup, group2: pool[0] || groupList[0], isHoliday: false });
    }
  }
  return schedule;
}

/* ==== FILTER BAR ==== */
function renderFilterBar(jadwal, groups) {
  const bulanSel = document.getElementById('filterBulan');
  const months = Array.from(new Set(jadwal.map(j=>j.date.slice(0,7))));
  bulanSel.innerHTML = '<option value="">Semua Bulan</option>' +
    months.map(ym=>`<option value="${ym}">${formatBulanTahun(ym+'-01')}</option>`).join('');
  const grupSel = document.getElementById('filterGrup');
  grupSel.innerHTML = '<option value="">Semua Grup</option>' +
    groups.map(g=>`<option value="${g}">${g}</option>`).join('');
  bulanSel.value = '';
  grupSel.value = '';
  document.getElementById('filterLibur').checked = false;
}
document.getElementById('filterBulan').onchange =
document.getElementById('filterGrup').onchange =
document.getElementById('filterLibur').onchange = function() {
  renderScheduleOutput(lastJadwal, lastGroups);
}

/* ==== Main Render Function ==== */
function renderScheduleOutput(jadwal, allGroups) {
  if (currentView === 'calendar') {
    renderCalendarView(jadwal, allGroups);
  } else {
    renderScheduleTable(jadwal, allGroups);
  }
}

/* ==== Calendar View Functions ==== */
function renderCalendarView(jadwal, allGroups) {
  const bulanVal = document.getElementById('filterBulan').value;
  const grupVal = document.getElementById('filterGrup').value;
  const liburOnly = document.getElementById('filterLibur').checked;
  
  let filtered = jadwal.filter(j=>{
    let byMonth = !bulanVal || j.date.slice(0,7)===bulanVal;
    let byGrup = !grupVal || j.group1===grupVal || j.group2===grupVal;
    let byLibur = !liburOnly || j.isHoliday;
    return byMonth && byGrup && byLibur;
  });

  let byMonth = groupByMonth(filtered);
  let monthKeys = Object.keys(byMonth).sort();
  
  let html = '';
  const today = new Date().toISOString().slice(0,10);
  
  if (monthKeys.length === 0 && bulanVal) {
      monthKeys = [bulanVal];
  } else if (monthKeys.length === 0) {
      monthKeys = lastMonths;
  }
  
  for (let ym of monthKeys) {
    const monthData = byMonth[ym] || [];
    const monthTitle = formatBulanTahun(ym + '-01');
    const scheduleMap = {};
    monthData.forEach(row => {
      scheduleMap[row.date] = row;
    });
    
    const [year, month] = ym.split('-').map(Number);
    const firstDayOfMonth = new Date(year, month - 1, 1);
    const lastDayOfMonth = new Date(year, month, 0);
    
    let gridStart = new Date(firstDayOfMonth);
    gridStart.setDate(gridStart.getDate() - gridStart.getDay());
    
    let gridEnd = new Date(lastDayOfMonth);
    if (gridEnd.getDay() !== 6) {
        gridEnd.setDate(gridEnd.getDate() + (6 - gridEnd.getDay()));
    }
    
    const days = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
    html += `<div class="calendar-container">
      <div class="calendar-header">${monthTitle}</div>
      <div class="calendar-grid">`;
    days.forEach(day => {
      html += `<div class="calendar-day-header">${day}</div>`;
    });
    const current = new Date(gridStart);
    while (current <= gridEnd) {
      const dateStr = current.toISOString().slice(0,10);
      const isCurrentMonth = current.getMonth() === firstDayOfMonth.getMonth();
      const isToday = dateStr === today;
      const scheduleData = scheduleMap[dateStr] || (lastJadwal.find(j => j.date === dateStr && liburOnly && j.isHoliday));

      let dayClass = 'calendar-day';
      if (!isCurrentMonth) dayClass += ' other-month';
      if (isToday) dayClass += ' today';
      
      const realScheduleData = lastJadwal.find(j => j.date === dateStr);
      if(realScheduleData?.isHoliday) dayClass += ' holiday';

      html += `<div class="${dayClass}">`;
      html += `<div class="calendar-date">${current.getDate()}</div>`;
      if (scheduleData) {
        html += '<div class="calendar-guards">';
        if (scheduleData.isHoliday) {
          html += '<div class="guard-item holiday">LIBUR</div>';
        } else {
          if (scheduleData.group1) {
            html += `<div class="guard-item">${scheduleData.group1}</div>`;
          }
          if (scheduleData.group2 && scheduleData.group2 !== scheduleData.group1) {
            // html += `<div class="guard-item">${scheduleData.group2}</div>`;
          }
        }
        html += '</div>';
      }
      html += '</div>';
      current.setDate(current.getDate() + 1);
    }
    html += '</div></div>';
  }
  document.getElementById('scheduleOut').innerHTML = html;
}


/* ==== Table View (Original) ==== */
function renderScheduleTable(jadwal, allGroups) {
  const bulanVal = document.getElementById('filterBulan').value;
  const grupVal = document.getElementById('filterGrup').value;
  const liburOnly = document.getElementById('filterLibur').checked;
  let filtered = jadwal.filter(j=>{
    let byMonth = !bulanVal || j.date.slice(0,7)===bulanVal;
    let byGrup = !grupVal || j.group1===grupVal || j.group2===grupVal;
    let byLibur = !liburOnly || j.isHoliday;
    return byMonth && byGrup && byLibur;
  });
  let byMonth = groupByMonth(filtered);
  let monthKeys = Object.keys(byMonth).sort();
  
  let html = '';
  for (let ym of monthKeys) {
    const rows = byMonth[ym];
    const monthTitle = formatBulanTahun(rows[0].date);
    const COL_HEIGHT = 12; // Adjusted for better fit
    let padded = padRows(rows, COL_HEIGHT);
    let colCnt = Math.ceil(padded.length / COL_HEIGHT);
    let cols = [];
    for (let c=0; c<colCnt; c++) {
      cols.push(padded.slice(c*COL_HEIGHT, (c+1)*COL_HEIGHT));
    }
    html += `<div class="panel-month">
      <div class="sticky-month">${monthTitle}</div>
      <div class="overflow-x-auto"><table class="w-full text-sm"><tbody><tr>`;
    
    // This part generates multiple tables for a columnar layout. 
    // The new CSS will style each one.
    for (let cc=0; cc<cols.length; cc++) {
      if (cc > 0) { // Add a subtle separator between columns
          html += `<td style="width: 1px; padding: 0; background-color: var(--gray-border);"></td>`;
      }
      html += `<td valign="top" colspan="2" style="padding:0; background:#f8fafc">
        <table class="w-full text-xs" style="margin:0">
          <thead>
            <tr>
              <th>Tanggal</th>
              <th>Regu Jaga</th>
            </tr>
          </thead>
          <tbody>
            ${cols[cc].map((row, ri)=>{
              if (!row) return `<tr><td class="empty-cell" colspan="2"></td></tr>`;
              let trClass = row.isHoliday ? 'holiday-row' : (ri%2===1 ? 'row-alt' : '');
              let groupText = row.group1;
              // if (row.group2 && row.group2 !== row.group1) groupText += `, ${row.group2}`;
              return `<tr class="${trClass}">
                <td style="white-space:nowrap;">${formatTanggal(row.date)}</td>
                <td>${groupText}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      </td>`;
    }
    html += `</tr></tbody></table></div></div>`;
  }
  document.getElementById('scheduleOut').innerHTML = html;
}


/* ==== EXPORT XLSX/CSV ==== */
async function exportToExcel() {
  if (!window.ExcelJS) {
    showNotif('Memuat library Excel...', 'info');
    await new Promise(resolve => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js';
      script.onload = resolve;
      document.head.appendChild(script);
    });
  }
  const rows = getScheduleDataForExport();
  if (!rows.length) return showNotif('Tidak ada data untuk diunduh!', 'error');
  const workbook = new window.ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Jadwal');
  worksheet.addRow(['Bulan','Tanggal','Hari','Regu Jaga']);
  rows.forEach(r=>worksheet.addRow(r));
  worksheet.columns.forEach(col => { col.width = 25; });
  const buf = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buf], {type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'jadwal_regu.xlsx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showNotif('Berhasil export ke Excel!');
}

function getScheduleDataForExport() {
  const bulanVal = document.getElementById('filterBulan').value;
  const grupVal = document.getElementById('filterGrup').value;
  const liburOnly = document.getElementById('filterLibur').checked;
  let filtered = lastJadwal.filter(j=>{
    let byMonth = !bulanVal || j.date.slice(0,7)===bulanVal;
    let byGrup = !grupVal || j.group1===grupVal || j.group2===grupVal;
    let byLibur = !liburOnly || j.isHoliday;
    return byMonth && byGrup && byLibur;
  });
  const hari = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  return filtered.map(row=>[
    formatBulanTahun(row.date),
    row.date,
    hari[new Date(row.date+"T00:00:00").getDay()],
    row.group1,
  ]);
}

document.getElementById('downloadXLSX').onclick = function() {
  exportToExcel();
};
document.getElementById('downloadCSV').onclick = function() {
  const rows = getScheduleDataForExport();
  if (!rows.length) return showNotif('Tidak ada data untuk diunduh!', 'error');
  let csv = 'Bulan,Tanggal,Hari,Regu Jaga\n'+rows.map(r=>r.map(v=>`"${(v || '').replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'jadwal_regu.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showNotif('Berhasil export ke CSV!');
};

/* ==== EXPORT/IMPORT GENERATOR ==== */
document.getElementById('exportGenerator').onclick = function() {
  if (!lastConfig.startDate) return showNotif('Generate jadwal dulu untuk export!', 'error');
  const data = { config: lastConfig, jadwal: lastJadwal };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `jadwal_regu_${lastConfig.startDate}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showNotif('Berhasil export Generator!');
};
document.getElementById('importGenBtn').onclick = function() {
  document.getElementById('importGenerator').click();
};
document.getElementById('importGenerator').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.config || !Array.isArray(data.jadwal)) throw new Error("Invalid format");
      
      const cfg = data.config;
      document.getElementById('startDate').value = cfg.startDate || "";
      document.getElementById('endDate').value = cfg.endDate || "";
      document.getElementById('groupList').value = (cfg.groups || []).join('\n');
      holidays = cfg.holidays || [];
      renderHolidayPicker();
      const orderRadio = document.querySelector(`input[name="orderType"][value="${cfg.orderType || 'shuffle'}"]`);
      if (orderRadio) orderRadio.checked = true;
      
      lastConfig = cfg;
      lastJadwal = data.jadwal;
      lastGroups = cfg.groups || [];
      lastMonths = Array.from(new Set(lastJadwal.map(j=>j.date.slice(0,7))));
      
      initViewToggle();
      renderFilterBar(lastJadwal, lastGroups);
      renderScheduleOutput(lastJadwal, lastGroups);
      showNotif('Berhasil import Generator!');
    } catch (err) {
      showNotif(`Error: ${err.message}`,'error');
    }
  };
  reader.readAsText(file);
  e.target.value = "";
};

// Auto-run on load to set initial date
document.addEventListener('DOMContentLoaded', () => {
    const startDateInput = document.getElementById('startDate');
    if (!startDateInput.value) {
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        startDateInput.value = firstDayOfMonth.toISOString().slice(0, 10);
        startDateInput.dispatchEvent(new Event('change')); // Trigger change to set end date
    }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
</body>
</html>
